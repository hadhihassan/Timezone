<!-- Header Start -->
<%- include('../partials/Customerside/header')%>
  <!-- Header End -->
  </header>
  <main>

    <!-- Hero Area Start-->
    <div class="slider-area ">
      <div class="single-slider slider-height2 d-flex align-items-center">
        <div class="container">
          <div class="row">
            <div class="col-xl-12">
              <div class="hero-cap text-center">
                <h2>Cart List</h2>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <% if (success && success.length> 0) { %>
      <div class="alert alert-success text-center" id="success-message">
        <% success.forEach(function(message) { %>
          <p>
            <%= message %>
          </p>
          <% }); %>
      </div>
      <script>
        setTimeout(function () {
          var successMessage = document.getElementById('success-message');
          if (successMessage) {
            successMessage.style.display = 'none';
          }
        }, 2000); 
      </script>
      <% } %>

        <!--================Cart Area =================-->
        <section class="cart_area section_padding">
          <div class="container">
            <div class="cart_inner">
              <div class="table-responsive">

                <div class="alert alert-succes text-center">
                  <p id="flash-message" style="color: green;"></p>
                </div>
                <!-- success message -->

                <table class="table">
                  <thead>
                    <tr>
                      <th scope="col">Product</th>
                      <th scope="col">Price</th>
                      <th scope="col">Quantity</th>
                      <th scope="col">Total</th>
                    </tr>
                  </thead>
                  <tbody>



                    <% Products.forEach((product, i)=> { %>
                      <% if ( currentUser.cart[i].quantity !==0 ) { %>


                        <tr>
                          <td>
                            <div>

                            </div>
                            <div class="media">
                              <div class="d-flex">
                                <img
                                  src="data:<%= product.product.images[0].contentType %>;base64,<%= product.product.images[0].data.toString('base64') %>"
                                  alt="<%= product.price %>">
                              </div>
                              <div>
                                <div class="media-body">
                                  <p class="font-weight-bold">
                                    <strong>
                                      <%= product.product.product_name %>
                                    </strong>
                                    <br><br>
                                  </p>
                                  <span class="font-weight-light">Color : <%= product.product.color %></span> <br>
                                  <br>
                                  <span class="font-weight-light"> Brand : <%= product.product.brand_name %></span>

                                </div>
                                <br>
                                <div>

                                  <a href="/user/remove-Cart-item?id=<%= currentUser.cart[i]._id %>" type="button"
                                    class=" btn-primary btn-sm me-1 mb-2" data-mdb-toggle="tooltip" title="Remove item">
                                    <i class="fas fa-trash"></i>
                                  </a>

                                  <a href="#" type="button" class=" btn-danger btn-sm mb-2" data-mdb-toggle="tooltip"
                                    title="Move to the wish list">
                                    <i class="fas fa-heart"></i>
                                  </a>

                                </div>
                              </div>
                            </div>
                          </td>
                          <td>
                            <p>

                              $ <%= product.product.price %>
                            </p>
                          </td>
                          <td>
                            <div class="product_count">
                              <button class="input-number-decrement btn btn-primary btn-sm" data-action="decrement"
                                data-cart-item-id="<%= product.product._id %>">
                                <i class="fas fa-minus"></i>
                              </button>
                              <input class="input-number" type="number" value="<%= currentUser.cart[i].quantity %>"
                                min="0" max="10" step="1" readonly>
                              <button class="input-number-increment btn btn-primary btn-sm" data-action="increment"
                                data-cart-item-id="<%= product.product._id %>">
                                <i class="fas fa-plus"></i>
                              </button>
                            </div>
                          </td>
                          <td>

                            <p class="price" id="cart-total-amount_<%= product.product._id %>"
                              data-cart-total-id="change_total" name="totalAmount">&#8377;<%=currentUser.cart[i].total
                                %>
                            </p>


                          </td>
                        </tr>
                        <% } %>
                          <% }) %>



                            <tr class="bottom_button">
                              <td>
                                <a class="btn_1" href="#">Update Cart</a>
                              </td>
                              <td></td>
                              <td></td>
                              <td>
                                <div class="cupon_text float-right">
                                  <a class="btn_1" href="#">Close Coupon</a>
                                </div>
                              </td>
                            </tr>
                            <tr>
                              <td></td>
                              <td></td>
                              <td>
                                <h5>Subtotal</h5>
                              </td>
                              <td>


                                <span id="subtotalAmount">
                                  <%= currentUser.totalCartAmount %>
                                </span>

                              </td>
                            </tr>
                            <tr class="shipping_area">
                              <td></td> 
                              <td></td>
                              <td>
                                <h5>Shipping</h5>
                              </td>
                              <td>
                                <div class="shipping_box">
                                  <ul class="list">
                                    <li>
                                      Flat Rate: $5.00
                                      <input type="radio" aria-label="Radio button for following text input">
                                    </li>
                                    <li>
                                      Free Shipping
                                      <input type="radio" aria-label="Radio button for following text input">
                                    </li>
                                    <li>
                                      Flat Rate: $10.00
                                      <input type="radio" aria-label="Radio button for following text input">
                                    </li>
                                    <li class="active">
                                      Local Delivery: $2.00
                                      <input type="radio" aria-label="Radio button for following text input">
                                    </li>
                                  </ul>
                                  <h6>
                                    Calculate Shipping
                                    <i class="fa fa-caret-down" aria-hidden="true"></i>
                                  </h6>
                                  <select class="shipping_select">
                                    <option value="1">Bangladesh</option>
                                    <option value="2">India</option>
                                    <option value="4">Pakistan</option>
                                  </select>
                                  <select class="shipping_select section_bg">
                                    <option value="1">Select a State</option>
                                    <option value="2">Select a State</option>
                                    <option value="4">Select a State</option>
                                  </select>
                                  <input class="post_code" type="text" placeholder="Postcode/Zipcode" />
                                  <a class="btn_1" href="#">Update Details</a>
                                </div>
                              </td>
                            </tr>
                  </tbody>
                </table>
                <div class="checkout_btn_inner float-right d-flex">
                  <a class="btn_1" href="/user/shop">Continue Shopping</a>

                  <form action="/user/Checkout" method="get">

                    <button type="submit" class="btn_1 checkout_btn_1">Proceed to checkout</button>
                  </form>
                </div>
              </div>
            </div>
        </section>
        <!--================End Cart Area =================-->
  </main>>
  <footer>
    <!-- Footer Start-->
    <%- include('../partials/Customerside/footer')%>
      <!-- Footer End-->
  </footer>
  <!--? Search model Begin -->
  <div class="search-model-box">
    <div class="h-100 d-flex align-items-center justify-content-center">
      <div class="search-close-btn">+</div>
      <form class="search-model-form">
        <input type="text" id="search-input" placeholder="Searching key.....">
      </form>
    </div>
  </div>
  <!-- Search model end -->

  <!-- JS here -->
  <script src="/Customer/js/vendor/modernizr-3.5.0.min.js"></script>
  <!-- Jquery, Popper, Bootstrap -->
  <script src="/Customer/js/vendor/jquery-1.12.4.min.js"></script>
  <script src="/Customer/js/popper.min.js"></script>
  <script src="/Customer/js/bootstrap.min.js"></script>
  <!-- Jquery Mobile Menu -->
  <script src="/Customer/js/jquery.slicknav.min.js"></script>

  <!-- Jquery Slick , Owl-Carousel Plugins -->
  <script src="/Customer/js/owl.carousel.min.js"></script>
  <script src="/Customer/js/slick.min.js"></script>

  <!-- One Page, Animated-HeadLin -->
  <script src="/Customer/js/wow.min.js"></script>
  <script src="/Customer/js/animated.headline.js"></script>
  <script src="/Customer/js/jquery.magnific-popup.js"></script>

  <!-- Scroll up, nice-select, sticky -->
  <script src="/Customer/js/jquery.scrollUp.min.js"></script>
  <script src="/Customer/js/jquery.nice-select.min.js"></script>
  <script src="/Customer/js/jquery.sticky.js"></script>

  <!-- contact js -->
  <script src="/Customer/js/contact.js"></script>
  <script src="/Customer/js/jquery.form.js"></script>
  <script src="/Customer/js/jquery.validate.min.js"></script>
  <script src="/Customer/js/mail-script.js"></script>
  <script src="/Customer/js/jquery.ajaxchimp.min.js"></script>

  <!-- Jquery Plugins, main Jquery -->
  <script src="/Customer/js/plugins.js"></script>
  <script src="/Customer/js/main.js"></script>
  <script src="https://code.jquery.com/jquery-2.2.4.js" integrity="sha256-iT6Q9iMJYuQiMWNd9lDyBUStIq/8PuOW33aOqmvFpqI="
    crossorigin="anonymous"></script>
  <!-- Add this script at the end of your HTML body -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="/Customer/js/memoryreload.js"></script>
  <script>
    // Get all input elements and increment/decrement buttons
    const inputNumbers = document.querySelectorAll(".input-number");
    const incrementButtons = document.querySelectorAll(".input-number-increment");
    const decrementButtons = document.querySelectorAll(".input-number-decrement");

    // Add click event listeners for all increment and decrement buttons
    incrementButtons.forEach((button, index) => {
      button.addEventListener("click", () => {
        updateCartItemQuantity(inputNumbers[index], "increment");
      });
    });

    decrementButtons.forEach((button, index) => {
      button.addEventListener("click", () => {
        updateCartItemQuantity(inputNumbers[index], "decrement");
      });
    });

    function updateCartItemQuantity(inputElement, action) {
      const cartItemId = inputElement.parentElement
        .querySelector(".input-number-increment")
        .getAttribute("data-cart-item-id");

      let currentValue = parseInt(inputElement.value);

      if (!isNaN(currentValue)) {
        if (action === "increment" && currentValue < 10) {
          currentValue++;
        } else if (action === "decrement" && currentValue > 1) {
          currentValue--;
        }
      }

      // Update the input value
      inputElement.value = currentValue;



      if (!isNaN(currentValue)) {
        $.ajax({
          url: "/update-cart-item-quantity", // Replace with your server-side route
          method: "POST", // or 'PUT' depending on your API
          data: {
            cartItemId: cartItemId,
            quantity: currentValue,
          },

          success: function (response) {
            if (response.stock) {
              displayFlashMessage(response.error)
            } else {
              console.log(response, 'res-out');
              if (response) {

                console.log(response, 'res');

                const newTotal = response.total;
                const cartTotal = document.querySelector(`#cart-total-amount_${cartItemId}`);
                cartTotal.textContent = newTotal;


                const subtotalAmount = response.totalCartAmount;
                const subtotalAmountElement =
                  document.querySelector("#subtotalAmount"); // Add an ID to your total amount element
                subtotalAmountElement.textContent = `â‚¹${subtotalAmount}`;

              } else {
                // Handle the error, e.g., display a message to the user
                console.error("Error in response:", response);
              }
            }
          }

          // error: function (error) {
          //       // Handle the AJAX error, e.g., display an error message
          //       console.error("AJAX error:", error);
          //     },
        });
      } else {
        // Handle the case where currentValue is not a valid number
        console.error("Invalid input value:", inputElement.value);
      }
    }




    function displayFlashMessage(message) {
      const flashMessageElement = document.getElementById('flash-message');
      flashMessageElement.textContent = message;
      flashMessageElement.style.display = 'block'; // Show the flash message

      setTimeout(() => {
        flashMessageElement.style.display = 'none'; // Hide the flash message after 3 seconds (adjust as needed)
      }, 4000);
    }
  </script>



  </body>

  </html>